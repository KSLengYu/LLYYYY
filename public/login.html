<!doctype html>
<html lang="zh-CN">
<head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>登录 / 注册</title>
<style>
  body{font-family:Arial;background:linear-gradient(180deg,#071026,#001021);color:#e6eef6;margin:0;padding:30px}
  .wrap{max-width:640px;margin:0 auto}
  .card{background:rgba(255,255,255,0.02);padding:20px;border-radius:12px}
  input{width:100%;padding:10px;margin-bottom:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
  .btn{background:linear-gradient(90deg,#06b6d4,#8b5cf6);color:#022;padding:10px 14px;border-radius:8px;border:none;cursor:pointer;transition:transform .12s}
  .muted{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:8px;color:#9ca3af;cursor:pointer}
  .row{display:flex;gap:8px;align-items:center}
  .small{color:#9ca3af}
  .modal-back{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center}
  .modal{background:rgba(255,255,255,0.02);padding:16px;border-radius:12px;max-width:420px}
  .progress{height:10px;border-radius:99px;background:rgba(255,255,255,0.06);overflow:hidden;margin-top:12px}
  .progress-bar{height:100%;width:0%;background:linear-gradient(90deg,#8b5cf6,#06b6d4);transition:width .6s}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2>登录 / 注册</h2>

      <div id="step1">
        <input id="email" placeholder="邮箱" />
        <div class="row">
          <button id="sendOtpBtn" class="btn">发送验证码</button>
          <button id="gotoPwdBtn" class="muted">密码登录</button>
          <div style="flex:1"></div>
          <button id="guestBtn" class="muted">游客模式</button>
        </div>
        <div class="small" style="margin-top:8px">验证码将发送到上方邮箱，填写后可直接登录或注册。</div>
      </div>

      <div id="step2" style="display:none;margin-top:8px">
        <input id="emailStep2" placeholder="邮箱 (与上步相同)" />
        <input id="otp" placeholder="验证码（6 位）" />
        <div class="row" style="margin-top:8px">
          <button id="verifyBtn" class="btn">验证并登录</button>
          <button id="backBtn" class="muted">返回上一步</button>
        </div>
      </div>

      <div id="pwdArea" style="display:none;margin-top:8px">
        <input id="emailLogin" placeholder="邮箱" />
        <input id="pwdLogin" type="password" placeholder="密码" />
        <div class="row" style="margin-top:8px">
          <button id="pwdLoginBtn" class="btn">密码登录</button>
          <a href="/register.html" class="small" style="margin-left:10px;color:#9ca3af;text-decoration:none">去注册</a>
        </div>
      </div>
    </div>
  </div>

  <div id="modalBack" class="modal-back"><div class="modal"><div id="modalTitle" style="font-weight:700"></div><div id="modalMsg" style="margin-top:8px"></div><div class="progress"><div id="progressBar" class="progress-bar"></div></div><div style="text-align:right;margin-top:12px"><button id="closeModal" class="btn">关闭</button></div></div></div>

<script>
async function api(path, opts={}) { return fetch('/api/v1/' + path, Object.assign({ credentials:'include' }, opts)); }
/* 新的 modal + 进度条（先慢推进，然后 1s 冲满） */
function showModal(title, content, autoCloseMs) {
  const back = document.getElementById('modalBack');
  const titleEl = document.getElementById('modalTitle');
  const contentEl = document.getElementById('modalContent') || document.getElementById('modalMsg'); // support different pages
  const bar = document.getElementById('progressBar');
  if (!back || !bar) {
    alert(title + '\n\n' + (content || '')); // fallback
    if (autoCloseMs && typeof autoCloseMs === 'function') autoCloseMs();
    return;
  }
  titleEl.textContent = title;
  contentEl.innerHTML = content || '';
  back.style.display = 'flex';

  // reset immediately (no transition)
  bar.style.transition = 'none';
  bar.style.width = '4%';

  // step1: slow fill to a mid value (e.g. 60%) over 800ms
  setTimeout(()=> {
    bar.style.transition = 'width 800ms cubic-bezier(.2,.9,.2,1)';
    bar.style.width = '60%';
  }, 80);

  // step2: after a short pause, do final fill to 100% with 1s transition
  setTimeout(()=> {
    bar.style.transition = 'width 1000ms cubic-bezier(.2,.9,.2,1)';
    bar.style.width = '100%';
  }, 950);

  // auto close and callback
  if (autoCloseMs) {
    setTimeout(()=> {
      back.style.display = 'none';
      if (typeof autoCloseMs === 'function') autoCloseMs();
    }, autoCloseMs + 1200); // keep a bit after animation
  }
}

document.getElementById('sendOtpBtn').addEventListener('click', async ()=>{
  const email = document.getElementById('email').value.trim(); if (!email) return alert('请输入邮箱');
  const res = await api('send-otp', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ email })});
  if (!res.ok) return alert('发送失败');
  document.getElementById('step1').style.display='none';
  document.getElementById('step2').style.display='block';
  document.getElementById('emailStep2').value = email;
});

document.getElementById('backBtn').addEventListener('click', ()=>{ document.getElementById('step2').style.display='none'; document.getElementById('step1').style.display='block'; });

document.getElementById('verifyBtn').addEventListener('click', async ()=>{
  const email = document.getElementById('emailStep2').value.trim();
  const otp = document.getElementById('otp').value.trim();
  if (!email || !otp) return alert('请输入邮箱与验证码');
  const res = await api('verify-otp', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ email, otp })});
  if (!res.ok) { const j = await res.json().catch(()=>({})); return alert(j.error || '验证失败'); }
  showModal('登录成功','验证通过，正在跳转...', ()=> location.href = '/');
});

document.getElementById('gotoPwdBtn').addEventListener('click', ()=>{ document.getElementById('pwdArea').style.display='block'; document.getElementById('step1').style.display='none'; });

document.getElementById('pwdLoginBtn').addEventListener('click', async ()=>{
  const email = document.getElementById('emailLogin').value.trim();
  const pwd = document.getElementById('pwdLogin').value;
  if (!email || !pwd) return alert('请输入邮箱与密码');
  const res = await api('login-password', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ email, password: pwd })});
  if (!res.ok) { const j = await res.json().catch(()=>({})); return alert(j.error || '登录失败'); }
  showModal('登录成功','密码验证通过，正在跳转...', ()=> location.href = '/');
});

// 游客模式
document.getElementById('guestBtn').addEventListener('click', async ()=>{
  const r = await api('guest-create', { method:'POST' });
  if (!r.ok) return alert('游客创建失败');
  showModal('游客模式','游客模式已启用，今天可发 5 条', ()=> location.href = '/');
});
</script>
</body>
</html>
